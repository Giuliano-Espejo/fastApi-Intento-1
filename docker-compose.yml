version: '3.8'

services:

  # â”€â”€â”€ Base de datos PostgreSQL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  db:
    image: postgres:15-alpine
    container_name: fastapi_db
    restart: always
    environment:
      POSTGRES_USER: fastapi_user
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: fastapi_app
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fastapi_user -d fastapi_app"]
      interval: 10s
      timeout: 5s
      retries: 5

  # â”€â”€â”€ API FastAPI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  api:
    build: .
    container_name: fastapi_api
    restart: always
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql+psycopg://fastapi_user:secret@db:5432/fastapi_app
      PYTHONPATH: /app/app
    depends_on:
      db:
        condition: service_healthy
    volumes:
      # Monta el cÃ³digo local para que --reload detecte cambios en tiempo real
      - ./:/app
    command: >
      sh -c "
        echo 'â³ Esperando a PostgreSQL...' &&
        echo 'ğŸ—„ï¸  Creando tablas si no existen...' &&
        python -c 'from core.database import create_db_and_tables; create_db_and_tables()' &&
        echo 'ğŸš€ Iniciando API en modo desarrollo...' &&
        uvicorn main:app --host 0.0.0.0 --port 8000 --reload
      "

volumes:
  postgres_data:

# â”€â”€â”€ Comandos Ãºtiles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Levantar servicios:        docker-compose up -d
# Ver logs en tiempo real:   docker-compose logs -f api
# Ver logs de la DB:         docker-compose logs -f db
# Detener servicios:         docker-compose down
# Eliminar todo + volÃºmenes: docker-compose down -v
# Reconstruir imagen:        docker-compose up -d --build